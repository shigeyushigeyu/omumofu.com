---
// src/pages/messageboard.astro
import Layout from '../layouts/Layout.astro';
// getDbClient のような関数を使っている場合
import { getDbClient } from '../lib/db'; 

// "let" で宣言し、try...finallyブロックで処理を完結させるのが安全
let threads = [];
let error = null;

try {
  // DB接続からデータ取得、接続終了までをすべてこのブロック内で行う
  // この部分はサーバーサイドでのみ実行されることが保証される
  const client = getDbClient(); 
  await client.connect();
  const result = await client.query('SELECT id, title, created_at FROM threads ORDER BY created_at DESC');
  threads = result.rows;
  await client.end();
} catch (err) {
  console.error("Database query failed:", err);
  error = "データベースからのデータ取得に失敗しました。";
}
// この時点で DB 接続に関するオブジェクト (client) はスコープ外になっているのが理想

---
<Layout title="掲示板">
  <main>
    <h1>掲示板スレッド一覧</h1>
    <ul>
      {threads.map(thread => (
        <li>
          <a href={`/thread/${thread.id}`}>{thread.title}</a>
          <small>({new Date(thread.created_at).toLocaleString()})</small>
        </li>
      ))}
    </ul>
    {threads.length === 0 && <p>まだスレッドがありません。</p>}
  </main>
</Layout>