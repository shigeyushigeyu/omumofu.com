---
// src/pages/messageboard.astro
import Layout from '../layouts/Layout.astro';
import { getDbClient } from '../lib/db';

// ★ try...catch を使わず、トップレベルで直接 await する！
// これが Astro の SSR で最もシンプルかつ推奨されるデータ取得方法。
const client = getDbClient();
await client.connect();
const result = await client.query('SELECT id, title, created_at FROM threads ORDER BY created_at DESC');
const threads = result.rows;
await client.end();

// もしこの過程でエラーが起きれば、Astroが自動的に500エラーページを
// 表示してくれる。デバッグはそのログを見て行うのが正道。
---
<Layout title="掲示板">
  <main>
    <h1>掲示板スレッド一覧</h1>
    
    {threads.length > 0 ? (
      <ul>
        {threads.map(thread => (
          <li>
            <a href={`/thread/${thread.id}`}>{thread.title}</a>
            <small>({new Date(thread.created_at).toLocaleString()})</small>
          </li>
        ))}
      </ul>
    ) : (
      <p>まだスレッドがありません。</p>
    )}

  </main>
</Layout>